<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="layout">
<head>
    <script th:src="@{/scripts/sockjs-0.3.4.js}" src="../static/scripts/sockjs-0.3.4.js"></script>
    <script th:src="@{/scripts/stomp.js}" src="../static/scripts/stomp.js"></script>

    <title>Readings</title>
    <script th:inline="javascript">
        /*<![CDATA[*/
        jQuery(document).ready(function ($) {
            $("#readings").bootgrid({
                navigation: 3,
                formatters: {
                        "dateTime": function(column, row) {
                            return row.dateTime;
                        }
                    }
            });
            retrieveReadings();
            connect();
        });

        var stompClient = null;

        function connect() {
            var socket = new SockJS([[@{/stomp}]]);
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/readingsUpdate', function(readings) {
                    retrieveReadings();
                });
            });
        }

        function disconnect() {
            if (stompClient != null) {
                stompClient.disconnect();
            }
            setConnected(false);
            console.log("Disconnected");
        }

        function retrieveReadings() {
            var today = new Date();
            var dd = today.getDate() - 1;
            var mm = today.getMonth() + 1; //January is 0!
            var yyyy = today.getFullYear();

            if (dd < 10) {
                dd='0' + dd;
            }

            if (mm < 10) {
                mm='0' + mm;
            }
            today = yyyy + '-' + mm + '-'+ dd;

            $.get("/rest/api/readings",
                 { dateTime: today + " 00:00:00",
                 timeZone: new Date().getTimezoneOffset() * -1 },
                function(data) {
                    $("#readings")
                        .bootgrid("clear")
                        .bootgrid("append", data);
                });
        }
        /*]]>*/
    </script>
    <style>
        .reading-grams-header {
            width: 10%;
        }
        .reading-degrees-header {
            width: 10%;
        }
    </style>
</head>

<body>
    <h1 layout:fragment="header">Readings</h1>
    <div layout:fragment="content" class="container">
        <div class="row">
            <div class="col-xs-12">
                <table id="readings" class="table table-condensed table-hover table-striped">
                    <thead>
                    <tr>
                        <th data-column-id="dateTime" data-formatter="dateTime">Time</th>
                        <th data-column-id="localDateTime">Local Time</th>
                        <th data-column-id="localTimeZone">Local Time Zone</th>
                        <th data-column-id="grams" data-type="numeric" data-align="right" data-header-align="right" data-header-css-class="reading-grams-header">Grams</th>
                        <th data-column-id="degreesC" data-type="numeric" data-align="right" data-header-align="right"  data-header-css-class="reading-degrees-header">Temperature</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
</html>